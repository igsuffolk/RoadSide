@page "/Report"

@using SharedProject.Models
@using RoadSide.Database
@using IndexedDB.Blazor
@using RoadSide.Interfaces
@using System.Text.Json
@using BlazorBootstrapToasts
@using RoadSide.Helpers
@using RoadSide.Models

@inject IIndexedDbFactory _dbFactory
@inject IHttpService _httpService
@inject IHttpServicePing _httpServicePing
@inject IJSRuntime _jsRuntime
@inject NavigationManager _navigationManager
@inject RoadSideAuthenticationStateProvider _roadSideAuthenticationStateProvider

@* 
  Report.razor
  - UI for creating and submitting a roadside report.
  - Supports taking/choosing a photo, geolocation via JS interop, offline storage (IndexedDB),
    and online submission to the API.
  - Uses injected services:
      _dbFactory            - IndexedDB access for offline reports
      _httpService          - HTTP helper to post reports
      _httpServicePing      - Lightweight ping to detect online status
      _jsRuntime            - JS interop for GPS coordinates
      _navigationManager    - navigation helper
      _roadSideAuthenticationStateProvider - to get current username
*@

<PageTitle>New Report</PageTitle>

<div class="container-fluid pb-5">

    @* Main form bound to Model; Submit is invoked on form submit *@
    <EditForm Model="@Model" OnSubmit="Submit" FormName="form1">
        @* Toast component used for user feedback (success/error notifications) *@
        <Toast @ref="Toast"></Toast>
        <div class="text-center">
            <h3>Report Road Issue</h3>
        </div>
        <p>Use this form to submit details of Road Issues to your local council.</p>

        @* Date card *@
        <div class="card shadow-sm  mt-2">
            <div class="card-body">
                <div class="card-title">
                    <h4><i class="bi bi-calendar-date "></i>&nbsp;Date</h4>
                </div>
                <InputDate class="form-control" @bind-Value="Model.ReportDate" />
            </div>
        </div>

        @* Photo card: shows preview if available and allows file selection *@
        <div class="card shadow-sm  mt-2">
            <div class="card-body">
                <div class="card-title">
                    <h4><i class="bi bi-camera"></i>&nbsp;Photo</h4>
                </div>
                <div class="text-center">
                    @{
                        if (!string.IsNullOrEmpty(ImageDataUrl))
                        {
                            <img src="@ImageDataUrl" width="100" />
                            <br />
                        }
                    }
                    <label for="photo" class="btn btn-primary mt-2">
                        @{
                            if (IsPhotoLoading)
                            {
                                <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                            }
                            else
                            {
                                <i class="bi bi-upload"></i>
                            }
                        }
                        &nbsp;Select Photo
                    </label>
                </div>
                @* Hidden InputFile element wired to LoadFile handler *@
                <InputFile class="form-control mt-2" id="photo" style="display:none;" OnChange="LoadFile" />

            </div>
        </div>

        @* Location card: road name and "Use GPS" button which calls JS to retrieve coordinates *@
        <div class="card shadow-sm  mt-2">
            <div class="card-body">
                <div class="card-title">
                    <h4><i class="bi bi-geo-alt"></i>&nbsp;Location</h4>
                </div>
                <label class="form-label">Road Name</label>
                <InputText class="form-control" @bind-Value="Model.RoadName" maxlength="500" />
                <div class="text-center">
                    <button type="button" class="btn btn-primary mt-2" @onclick="@GetCoords">
                        @{
                            if (IsGpsLoading)
                            {
                                <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                            }
                            else
                            {
                                <i class="bi bi-pin-map"></i>
                            }
                        }
                        &nbsp;Use GPS
                    </button>

                    @{
                        if (Model.Latitude != 0)
                        {
                            <div class="divGps mt-2">
                                <label><i class="bi bi-check-lg"></i>&nbsp;GPS: @Model.Latitude , @Model.Longitude</label>
                            </div>
                        }

                    }
                </div>
            </div>
        </div>

        @* Issue details and submit button *@
        <div class="card shadow-sm  mt-2">
            <div class="card-body">
                <div class="card-title">
                    <h4><i class="bi bi-exclamation-triangle"></i>&nbsp;Issue Details</h4>
                </div>
                <label class="form-label">Description</label>
                <InputTextArea class="form-control" @bind-Value="Model.Description" maxlength="2000" rows="4" />
                <div class="text-center">
                    <button type="submit" class="btn btn-primary mt-2">
                        @{
                            if (IsSending)
                            {
                                <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                            }
                            else
                            {
                                <i class="bi bi-floppy"></i>
                            }

                        }
                        <span role="status">&nbsp;Submit Fault Report</span>
                    </button>
                </div>
            </div>
        </div>

        @* Offline-synced reports panel: shown when there are locally saved reports awaiting upload *@
        @{
            if (ListReports.Count > 0)
            {
                <div class="card shadow-sm  mt-2">
                    <div class="card-body">
                        <div class="card-title">
                            <h4><i class="bi bi-exclamation-triangle"></i>&nbsp;Sync Reports&nbsp;(@ListReports.Count)</h4>
                        </div>
                        <div class="text-center">
                            <button type="button" class="btn btn-primary mt-2" @onclick="@UploadReports">
                                @{
                                    if (IsUploading)
                                    {
                                        <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-cloud-arrow-up"></i>
                                    }

                                }
                                <span role="status">&nbsp;Send Reports</span>
                            </button>
                        </div>
                    </div>
                </div>
            }
        }

    </EditForm>

</div>

@code {
    // The DTO bound to the form. Contains report fields and optional photo bytes.
    public RoadReportDTO Model = new();

    // Cached list of locally stored reports (IndexedDB). Shown in Sync Reports panel.
    public List<RoadReportDTO> ListReports = new();

    // Base64 data URL used to preview the selected photo in the UI.
    public string ImageDataUrl = string.Empty;

    // Reference to the Toast component used to show immediate feedback to the user.
    public Toast Toast { get; set; } = new();

    // Username of the currently authenticated user (set on first render).
    public string ReportedBy = string.Empty;

    // UI state flags to control spinners and button states.
    public bool IsSending = false;
    public bool IsUploading = false;
    public bool IsPhotoLoading = false;
    public bool IsGpsLoading = false;

    /// <summary>
    /// Lifecycle hook: runs after first render. Loads saved reports and gets the current username.
    /// </summary>
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Get the logged in username from the custom auth provider.
            ReportedBy = _roadSideAuthenticationStateProvider.Username;

            // Load any locally stored reports to show sync status.
            await LoadReports();
        }
    }

    /// <summary>
    /// Uploads locally stored reports to the API when online.
    /// Removes each report from IndexedDB after successful send.
    /// </summary>
    private async Task UploadReports()
    {
        IsUploading = true;
        StateHasChanged();

        if (await PingApi())
        {
            using (var db = await _dbFactory.Create<Roadside>())
            {
                foreach (RoadReportDTO report in ListReports)
                {
                    bool result = await _httpService.PostAsyncBool<RoadReportDTO>("Home", report);
                    if (result)
                    {
                        // Remove successfully sent report from local store.
                        db.RoadReports.Remove(report);
                        await db.SaveChanges();
                    }
                }

            }
            await LoadReports();
        }
        else
        {
            await Toast.Show("danger", "You appear to be offline. Please try later.", 3000);
        }

        IsUploading = false;
        StateHasChanged();
    }

    /// <summary>
    /// Loads locally saved reports from IndexedDB into ListReports.
    /// </summary>
    private async Task LoadReports()
    {
        using (var db = await _dbFactory.Create<Roadside>())
        {
            ListReports = db.RoadReports.ToList();
        }

        StateHasChanged();
    }

    /// <summary>
    /// Reads the selected image file into Model.Photo and updates the preview image data URL.
    /// Uses a 10MB max allowed size. Runs on InputFile OnChange.
    /// </summary>
    private async void LoadFile(InputFileChangeEventArgs e)
    {
        IsPhotoLoading = true;
        StateHasChanged();

        var stream = e.File.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        Model.Photo = ms.ToArray();

        // Create data URL for preview (small thumbnails).
        ImageDataUrl = $"data:image;base64,{Convert.ToBase64String(Model.Photo)}";

        IsPhotoLoading = false;

        StateHasChanged();
    }

    /// <summary>
    /// Handles form submission.
    /// - Validates required fields client-side.
    /// - Attempts to POST to API if online; otherwise stores the report locally (IndexedDB).
    /// - Shows user feedback via Toast.
    /// </summary>
    private async Task Submit()
    {
        if (string.IsNullOrEmpty(Model.RoadName))
        {
            await Toast.Show("danger", "Please enter a Road Name", 3000);
            return;
        }
        if (string.IsNullOrEmpty(Model.Description))
        {
            await Toast.Show("danger", "Please enter a description", 3000);
            return;
        }

        Model.ReportedBy = ReportedBy;

        IsSending = true;
        StateHasChanged();

        if (await PingApi())
        {
            bool result = false;
            try
            {
                // Send report to API endpoint "Home"
                result = await _httpService.PostAsyncBool<RoadReportDTO>("Home", Model);
            }
            catch (Exception ex)
            {
                // Log but keep UX friendly; offline fallback will save locally.
                result = false;
                Console.WriteLine(ex.Message + " " + ex.StackTrace);
                await Toast.Show("danger", "There was an error sending the report.", 3000);
            }

            if (result)
            {
                await Toast.Show("success", "Thank you. Your report has been submitted.", 3000);
            }
            else
            {
                await Toast.Show("danger", "There was an error sending the report.", 3000);
            }

        }
        else
        {
            // Offline: save report into IndexedDB for later upload.
            using (var db = await _dbFactory.Create<Roadside>())
            {
                db.RoadReports.Add(Model);

                await db.SaveChanges();
            }

            await Toast.Show("success", "Thank you. You are offline. Your report has been saved for later sending.", 3000);
        }

        // Reset the form for new input but preserve ReportedBy.
        Model = new();
        Model.ReportedBy = ReportedBy;
        ImageDataUrl = string.Empty;

        await LoadReports();

        IsSending = false;

        StateHasChanged();
    }

    /// <summary>
    /// Uses JS interop to request the device's geolocation.
    /// Expects a JS function "getCoords" that returns an object with { lat, lng }.
    /// </summary>
    private async Task GetCoords()
    {
        IsGpsLoading = true;
        StateHasChanged();
        // await _jsRuntime.InvokeVoidAsync("iain");
        Coords myCoords = await _jsRuntime.InvokeAsync<Coords>("getCoords");

        Model.Latitude = myCoords.Lat;
        Model.Longitude = myCoords.Lng;

        IsGpsLoading = false;
        StateHasChanged();

    }

    /// <summary>
    /// Lightweight check that the API is reachable. Uses injected IHttpServicePing.
    /// </summary>
    private async Task<bool> PingApi()
    {
        bool result = await _httpServicePing.Ping();

        return result;
    }

    /// <summary>
    /// Navigation helper to go back to the reports list page.
    /// </summary>
    private void GoBack()
    {
        _navigationManager.NavigateTo("/ReportsList");
    }

    /// <summary>
    /// Simple DTO used to receive coordinates from JS interop.
    /// </summary>
    public class Coords
    {
        public double Lat { get; set; }
        public double Lng { get; set; }
    }
}
